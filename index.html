<!DOCTYPE html>
<html>
<head>
	<title>Pinger</title>
	<meta charset="UTF-8">
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
	<script
	  src="https://code.jquery.com/jquery-3.5.1.min.js"
	  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
	  crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
	<script src="https://kit.fontawesome.com/8c58d132fd.js" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/gh/alfg/ping.js@0.2.2/dist/ping.min.js" type="text/javascript"></script>
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
</head>
<body>
	<div class="container">
		<div class="jumbotron">
			<h1 class="text-center">Bienvenue sur TestPing <i class="fas fa-chart-line"></i></h1>
		</div>
		<div class="row">
			<div class="col-lg-12">
				<form class="justify-content-center">
					<div class="col">
						<div class="toPing" value="128.114.119.137">
						<label for="validationServerUsername">Rentrez l'URL Ã  ping</label>
						<div class="input-group">
							<div class="input-group-prepend">
								<span class="input-group-text"><i class="fas fa-terminal"></i></span>
							</div>
							<input type="text" class="form-control" placeholder="https://ping.zenetys.com/api" id="urlToPing" required>
							<div class="input-group-append">
								<button class="btn btn-primary" type="button" id="launchTest">Lancer le test <i class="fas fa-play"></i></button>
							</div>
						</div>
					</div>
				</div>
			</form>
		</div>
		<div class="row text-center" id="divChart" style="width: 100%">
			<canvas id="pingChart"></canvas>
		</div>
	</div>
</body>
</html>
<script type="text/javascript">
	(function() {
		sizeCanvas();
		window.onresize = sizeCanvas;
	})();

	function sizeCanvas(){
	    var canvas = document.getElementById('pingChart');
        canvas.width = $('#divChart').width();
	}

	$('#launchTest').on('click',function(){
		var canvas = document.getElementById('pingChart');
		var ctx = canvas.getContext('2d');
		ctx.clearRect(0, 0, canvas.width, canvas.height);

		var expressionUrl = /https?:\/\/(www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z0-9()@:%_\+.~#?&//=]*)/gi;
		var regexUrl = new RegExp(expressionUrl);

		var urlToPing = $('#urlToPing').val();

		if (urlToPing == "") {
			urlToPing = "https://ping.zenetys.com/api";
		}
		if (urlToPing.match(regexUrl)) {
			$('#launchTest').html('Test en cours... <i class="fas fa-cog fa-spin"></i>');
			$('#launchTest').prop('disabled',true);
			pingUrl(urlToPing);
		}else{
			Swal.fire(
			  'Erreur',
			  'Veuillez rentrer une URL valide',
			  'error'
			)
			console.log("url non valide");
		}
	});

	
	function pingUrl(url){
		var pings = [];
		console.log(url);
		var i = 0;
		const interval = setInterval(function(){
			if (i < 5) {
				var p = new Ping();
				p.ping(url, function(err,data) {
					pings[i] = data;
					i++;
				});
			}else{
				showPing(pings);
				clearInterval(interval);
			}
		},1000);

	}

	function showPing(pings){
		$('#launchTest').html('Relancer un test <i class="fas fa-play"></i>');
		$('#launchTest').prop('disabled',false);
		var color = [];
		for (var i = 0; i < 5; i++){
			if (pings[i] > 1000) {
				color[i] = 'rgba(255,0,0,1)';
			}else{
				if (pings[i] > 500) {
					color[i] = 'rgba(255, 127, 0, 1)';
				}else{
					color[i] = 'rgba(0, 255, 0, 1)';
				}
			}
		}
		var canvas = document.getElementById('pingChart');
		var ctx = canvas.getContext('2d');
		ctx.clearRect(0, 0, canvas.width, canvas.height);
		var myChart = new Chart(ctx, {
		    type: 'line',
		    data: {
		        labels: ['1', '2', '3', '4', '5'],
		        datasets: [{
		            label: 'ms',
		            data: pings,
		            fill: false,
		            backgroundColor: color,
                   	pointRadius: 7,
                   	pointHoverRadius: 10
		        }]
		    },
		    options: {
		        scales: {
		            yAxes: [{
		                ticks: {
		                    beginAtZero: true
		                }
		            }]
		        }
		    }
		});
	}
</script>